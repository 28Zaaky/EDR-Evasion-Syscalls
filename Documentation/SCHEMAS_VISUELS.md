# SchÃ©mas et Diagrammes - Syscalls EDR

## 1. Architecture Windows : Flux d'un Appel SystÃ¨me

### 1.1 Appel Normal (Sans EDR)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    APPLICATION (Ring 3)                      â”‚
â”‚                                                              â”‚
â”‚  [1] mon_programme.exe                                       â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”‚ VirtualAlloc()                                      â”‚
â”‚       â–¼                                                      â”‚
â”‚  [2] KERNEL32.DLL                                           â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”‚ VirtualAllocEx() â†’ forwarding                       â”‚
â”‚       â–¼                                                      â”‚
â”‚  [3] KERNELBASE.DLL                                         â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”‚ NtAllocateVirtualMemory()                           â”‚
â”‚       â–¼                                                      â”‚
â”‚  [4] NTDLL.DLL                                              â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚       â”‚ â”‚ NtAllocateVirtualMemory:            â”‚            â”‚
â”‚       â”‚ â”‚   4C 8B D1     mov r10, rcx        â”‚            â”‚
â”‚       â”‚ â”‚   B8 18 00..   mov eax, 0x18       â”‚ â† SSN      â”‚
â”‚       â”‚ â”‚   0F 05        syscall               â”‚            â”‚
â”‚       â”‚ â”‚   C3           ret                   â”‚            â”‚
â”‚       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚       â–¼                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ SYSCALL (interruption logicielle)
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              WINDOWS KERNEL (Ring 0)                         â”‚
â”‚                                                              â”‚
â”‚  [5] NTOSKRNL.EXE                                           â”‚
â”‚      â€¢ NtAllocateVirtualMemory (implÃ©mentation rÃ©elle)      â”‚
â”‚      â€¢ Gestion de la mÃ©moire virtuelle                      â”‚
â”‚      â€¢ Allocation des pages physiques                       â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â±ï¸ Temps total : ~100 cycles CPU
```

### 1.2 Appel avec EDR (Hook Actif)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    APPLICATION (Ring 3)                      â”‚
â”‚                                                              â”‚
â”‚  [1] mon_programme.exe                                       â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”‚ VirtualAlloc()                                      â”‚
â”‚       â–¼                                                      â”‚
â”‚  [2] KERNEL32.DLL                                           â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”‚ VirtualAllocEx() â†’ forwarding                       â”‚
â”‚       â–¼                                                      â”‚
â”‚  [3] KERNELBASE.DLL                                         â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”‚ NtAllocateVirtualMemory()                           â”‚
â”‚       â–¼                                                      â”‚
â”‚  [4] NTDLL.DLL âš ï¸ HOOKÃ‰E PAR EDR                           â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚       â”‚ â”‚ NtAllocateVirtualMemory:            â”‚            â”‚
â”‚       â”‚ â”‚   E9 XX XX XX  jmp EDR_Hook â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”         â”‚
â”‚       â”‚ â”‚   XX                                 â”‚  â”‚         â”‚
â”‚       â”‚ â”‚   0F 05        syscall               â”‚  â”‚         â”‚
â”‚       â”‚ â”‚   C3           ret                   â”‚  â”‚         â”‚
â”‚       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚
â”‚       â”‚                                           â”‚         â”‚
â”‚       â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚
â”‚       â”‚ â”‚ EDR_Hook: (Code de l'EDR)          â”‚ â—„â”˜         â”‚
â”‚       â”‚ â”‚  â€¢ Analyser les paramÃ¨tres          â”‚            â”‚
â”‚       â”‚ â”‚  â€¢ VÃ©rifier si malveillant          â”‚            â”‚
â”‚       â”‚ â”‚  â€¢ Logger l'opÃ©ration                â”‚            â”‚
â”‚       â”‚ â”‚  â€¢ âš ï¸ BLOQUER si suspect            â”‚            â”‚
â”‚       â”‚ â”‚  â€¢ Sinon : restaurer et continuer   â”‚            â”‚
â”‚       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚       â–¼                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ SYSCALL (si autorisÃ© par l'EDR)
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              WINDOWS KERNEL (Ring 0)                         â”‚
â”‚                                                              â”‚
â”‚  [5] NTOSKRNL.EXE                                           â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â±ï¸ Temps total : ~1000 cycles CPU (analyse EDR)
ğŸ”´ DÃ‰TECTION : Hook intercepte l'appel
```

---

## 2. Bypass EDR : Syscalls Directs

### 2.1 Flux avec Syscalls Directs

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MALWARE (Ring 3)                          â”‚
â”‚                                                              â”‚
â”‚  [1] malware.exe                                             â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”‚ âŒ Pas d'appel Ã  KERNEL32/KERNELBASE               â”‚
â”‚       â”‚ âŒ Pas d'appel Ã  NTDLL                              â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”‚ âœ… Code assembleur inline                          â”‚
â”‚       â–¼                                                      â”‚
â”‚  [2] â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚      â”‚ NtAllocateVirtualMemory_Direct:     â”‚               â”‚
â”‚      â”‚   mov r10, rcx                      â”‚               â”‚
â”‚      â”‚   mov eax, 0x18      â† SSN hardcodÃ© â”‚               â”‚
â”‚      â”‚   mov rcx, [param1]                 â”‚               â”‚
â”‚      â”‚   mov rdx, [param2]                 â”‚               â”‚
â”‚      â”‚   ...                                â”‚               â”‚
â”‚      â”‚   syscall            â† DIRECT !     â”‚               â”‚
â”‚      â”‚   ret                                â”‚               â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚       â–¼                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ SYSCALL (bypass complet de ntdll.dll)
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              WINDOWS KERNEL (Ring 0)                         â”‚
â”‚                                                              â”‚
â”‚  [3] NTOSKRNL.EXE                                           â”‚
â”‚      â€¢ ReÃ§oit directement le syscall                        â”‚
â”‚      â€¢ âœ… Aucun hook EDR traversÃ©                          â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… AVANTAGES :
  â€¢ Bypass total des hooks ntdll
  â€¢ Rapide (pas d'analyse EDR)
  â€¢ Simple Ã  implÃ©menter

âŒ INCONVÃ‰NIENTS :
  â€¢ Instruction "syscall" dans notre code (dÃ©tectable)
  â€¢ SSN hardcodÃ©s (diffÃ©rents selon version Windows)
  â€¢ Call stack anormale (sans ntdll)
  â€¢ DÃ©tectable par analyse statique
```

### 2.2 DÃ©tection par EDR des Syscalls Directs

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  TECHNIQUES DE DÃ‰TECTION                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[1] ANALYSE STATIQUE
    â€¢ Scanner le binaire pour l'instruction "0F 05" (syscall)
    â€¢ DÃ©tection de sÃ©quences : mov eax, XX; syscall
    â€¢ Signature : SSN hardcodÃ© dans le code
    
    Fichier : malware.exe
    Offset  : 0x1234
    Bytes   : B8 18 00 00 00 0F 05  â† mov eax, 0x18; syscall
    Verdict : âš ï¸ SUSPECT
    
[2] ANALYSE DE LA CALL STACK
    â€¢ VÃ©rifier la pile d'appels lors d'un syscall
    
    Call Stack NORMALE :
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ntdll!NtAllocate... â”‚ â† Devrait Ãªtre prÃ©sent
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ kernelbase!Virtual..â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ mon_app.exe         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    Call Stack ANORMALE (syscall direct) :
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ malware.exe         â”‚ â† Syscall depuis .text section !
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    Verdict : ğŸ”´ MALVEILLANT
    
[3] ETW (Event Tracing for Windows)
    â€¢ Surveillance au niveau kernel
    â€¢ DÃ©tection des allocations RWX
    â€¢ Pattern d'opÃ©rations suspectes
    
    Events dÃ©tectÃ©s :
    - ProcessId=1234 allocated RWX memory (SUSPECT)
    - Syscall from user .text section (ANOMALIE)
    - No ntdll in call stack (MALVEILLANT)
```

---

## 3. Bypass EDR AvancÃ© : Syscalls Indirects

### 3.1 Flux avec Syscalls Indirects

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MALWARE (Ring 3)                          â”‚
â”‚                                                              â”‚
â”‚  [1] malware.exe                                             â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”‚ INITIALISATION (une seule fois)                     â”‚
â”‚       â”œâ”€â–º [A] Charger ntdll.dll fraÃ®che depuis disque       â”‚
â”‚       â”‚        (pas la version hookÃ©e en mÃ©moire)           â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚       â”‚   â”‚ C:\Windows\System32\ntdll.dll    â”‚             â”‚
â”‚       â”‚   â”‚ (Copie PROPRE, aucun hook EDR)   â”‚             â”‚
â”‚       â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”œâ”€â–º [B] Parser le PE pour extraire les SSN           â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”‚   NtAllocateVirtualMemory â†’ SSN: 0x18              â”‚
â”‚       â”‚   NtWriteVirtualMemory    â†’ SSN: 0x3A              â”‚
â”‚       â”‚   NtProtectVirtualMemory  â†’ SSN: 0x50              â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”œâ”€â–º [C] Trouver "syscall; ret" dans ntdll mappÃ©e     â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”‚   Recherche bytes: 0F 05 C3                         â”‚
â”‚       â”‚   TrouvÃ© Ã : 0x7FFE12345678                          â”‚
â”‚       â”‚                                                      â”‚
â”‚       â–¼                                                      â”‚
â”‚  [2] EXÃ‰CUTION                                               â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”‚ NtAllocateVirtualMemory_Indirect()                  â”‚
â”‚       â–¼                                                      â”‚
â”‚  [3] â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚      â”‚ Notre code assembleur:               â”‚               â”‚
â”‚      â”‚   mov r10, rcx                      â”‚               â”‚
â”‚      â”‚   mov eax, [ssn]    â† SSN extrait   â”‚               â”‚
â”‚      â”‚   mov rcx, [param1]                 â”‚               â”‚
â”‚      â”‚   mov rdx, [param2]                 â”‚               â”‚
â”‚      â”‚   ...                                â”‚               â”‚
â”‚      â”‚   jmp [syscallAddr] â† JUMP vers ntdllâ”‚              â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚       â”‚                                                      â”‚
â”‚       â–¼                                                      â”‚
â”‚  [4] NTDLL.DLL (mappÃ©e, possiblement hookÃ©e mais on        â”‚
â”‚      saute directement Ã  l'instruction syscall)             â”‚
â”‚       â”‚                                                      â”‚
â”‚       â”‚ Adresse: 0x7FFE12345678                             â”‚
â”‚       â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚       â”‚ â”‚   0F 05        syscall               â”‚            â”‚
â”‚       â”‚ â”‚   C3           ret                   â”‚            â”‚
â”‚       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚       â–¼                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ SYSCALL (depuis ntdll lÃ©gitime !)
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              WINDOWS KERNEL (Ring 0)                         â”‚
â”‚                                                              â”‚
â”‚  [5] NTOSKRNL.EXE                                           â”‚
â”‚      â€¢ ReÃ§oit le syscall                                    â”‚
â”‚      â€¢ Call stack semble lÃ©gitime (via ntdll)               â”‚
â”‚      â€¢ âœ… Difficile Ã  distinguer d'un appel normal         â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… AVANTAGES :
  â€¢ Pas d'instruction syscall dans notre code
  â€¢ SSN extraits dynamiquement (compatible toutes versions)
  â€¢ Call stack lÃ©gitime (via ntdll)
  â€¢ TrÃ¨s difficile Ã  dÃ©tecter

âŒ INCONVÃ‰NIENTS :
  â€¢ Plus complexe Ã  implÃ©menter
  â€¢ NÃ©cessite parsing PE
  â€¢ LÃ©gÃ¨rement plus lent (initialisation)
```

### 3.2 DÃ©tail du Parsing PE

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           PARSING PE DE NTDLL.DLL FRAÃCHE                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[Ã‰TAPE 1] Lire ntdll.dll depuis le disque
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DOS Header                      â”‚
â”‚  e_magic: "MZ"                 â”‚
â”‚  e_lfanew: 0x108 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”˜
                               â”‚
[Ã‰TAPE 2] Trouver NT Headers   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NT Headers (offset 0x108)      â”‚
â”‚  Signature: "PE\0\0"           â”‚
â”‚  FileHeader:                   â”‚
â”‚    NumberOfSections: 5         â”‚
â”‚  OptionalHeader:               â”‚
â”‚    DataDirectory[0]: â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â” Export Directory
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                    â”‚
[Ã‰TAPE 3] Export Directory         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Export Directory Table             â”‚
â”‚  NumberOfFunctions: 2134           â”‚
â”‚  NumberOfNames: 2134               â”‚
â”‚  AddressOfFunctions: 0x9B0E0       â”‚
â”‚  AddressOfNames: 0x9C394           â”‚
â”‚  AddressOfNameOrdinals: 0x9D638    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
[Ã‰TAPE 4] Parcourir les noms
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AddressOfNames[0]: "EtwEventWrite" â”‚
â”‚ AddressOfNames[1]: "LdrLoadDll"    â”‚
â”‚ ...                                 â”‚
â”‚ AddressOfNames[523]: "NtAlloc..." â—„â”€â”€ TrouvÃ© !
â”‚ ...                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
[Ã‰TAPE 5] Obtenir l'adresse RVA
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Ordinal[523]: 42                   â”‚
â”‚ AddressOfFunctions[42]: 0x8F3A0    â”‚
â”‚ â†’ Adresse absolue:                 â”‚
â”‚   base(0x7FFE00000000) +           â”‚
â”‚   RVA(0x8F3A0) =                   â”‚
â”‚   0x7FFE0008F3A0                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
[Ã‰TAPE 6] Extraire le SSN
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Adresse: 0x7FFE0008F3A0            â”‚
â”‚                                     â”‚
â”‚ Bytes:                              â”‚
â”‚   4C 8B D1           mov r10, rcx â”‚
â”‚   B8 18 00 00 00     mov eax, 0x18â”‚ â—„â”€â”€ SSN = 0x18
â”‚   0F 05              syscall       â”‚
â”‚   C3                 ret           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ“ SSN extrait : 0x18
âœ“ Fonction identifiÃ©e : NtAllocateVirtualMemory
```

---

## 4. Comparaison Visuelle

### 4.1 Vue d'ensemble des 3 approches

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    APPROCHE 1 : API WINDOWS                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[APP] VirtualAlloc()
  â†“
[KERNEL32] VirtualAllocEx()
  â†“
[KERNELBASE] NtAllocateVirtualMemory()
  â†“
[NTDLL] âš ï¸ HOOK EDR DÃ‰TECTE ET PEUT BLOQUER
  â†“
[KERNEL] Allocation mÃ©moire

DÃ©tection: ğŸ”´ HAUTE
FacilitÃ©: ğŸŸ¢ TrÃ¨s facile
FurtivitÃ©: ğŸ”´ Nulle


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘               APPROCHE 2 : SYSCALLS DIRECTS                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[APP/MALWARE]
  â†“
[Code ASM inline]
  mov eax, 0x18    â† SSN hardcodÃ©
  syscall          â† Instruction dÃ©tectable
  ret
  â†“
[KERNEL] Allocation mÃ©moire

DÃ©tection: ğŸŸ¡ MOYENNE
  â€¢ Instruction syscall dans le code
  â€¢ Call stack anormale
  â€¢ Analyse statique possible
  
FacilitÃ©: ğŸŸ¡ Moyenne
FurtivitÃ©: ğŸŸ¡ Moyenne


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              APPROCHE 3 : SYSCALLS INDIRECTS                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

[APP/MALWARE]
  â†“
[Charger ntdll fraÃ®che]
  â†“
[Extraire SSN dynamiquement] â†’ SSN: 0x18
  â†“
[Code ASM inline]
  mov eax, 0x18    â† SSN extrait
  jmp [ntdll+X]    â† Jump vers ntdll (pas de syscall direct)
  â†“
[NTDLL lÃ©gitime]
  syscall          â† Instruction dans ntdll (lÃ©gitime)
  ret
  â†“
[KERNEL] Allocation mÃ©moire

DÃ©tection: ğŸŸ¢ FAIBLE
  â€¢ Pas d'instruction syscall dans notre code
  â€¢ Call stack lÃ©gitime (via ntdll)
  â€¢ Analyse statique trÃ¨s difficile
  
FacilitÃ©: ğŸ”´ Complexe
FurtivitÃ©: ğŸŸ¢ Haute
```

### 4.2 Timeline de DÃ©tection EDR

```
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TEMPS                    2015        2018        2020        2023
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

API Windows        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
(VirtualAlloc)     ğŸ”´ DÃ©tectÃ©      ğŸ”´ BloquÃ©    ğŸ”´ BloquÃ©

Syscalls Directs               ğŸŸ¢ OK  ğŸŸ¡ DÃ©tectÃ© ğŸ”´ BloquÃ©
                                      â”œâ”€ Analyse statique
                                      â””â”€ Call stack check

Syscalls Indirects                        ğŸŸ¢ OK  ğŸŸ¡ DÃ©tectÃ©*
                                                 â””â”€ Heuristiques
                                                    comportementales

Syscalls Indirects                               ğŸŸ¢ OK
+ Obfuscation                                    â””â”€ Difficile
                                                    Ã  dÃ©tecter

* DÃ©tection partielle par EDR avancÃ©s avec :
  - ETW (Event Tracing)
  - Kernel Callbacks
  - Analyse comportementale ML/AI
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

---

## 5. SchÃ©ma de MÃ©moire

### 5.1 Layout MÃ©moire d'un Processus

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ESPACE MÃ‰MOIRE DU PROCESSUS (x64)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  0x00007FFFFFFFFFFF â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚                      â”‚   Kernel Space           â”‚            â”‚
â”‚                      â”‚   (Ring 0)               â”‚            â”‚
â”‚  0x00007FFF00000000 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚                      â”‚                          â”‚            â”‚
â”‚                      â”‚   NTDLL.DLL              â”‚ âš ï¸ HookÃ©eâ”‚
â”‚  0x00007FFE12340000 â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   par EDR â”‚
â”‚                      â”‚   â”‚ .text (code)     â”‚  â”‚            â”‚
â”‚                      â”‚   â”‚  NtAllocate...   â”‚  â”‚            â”‚
â”‚                      â”‚   â”‚    0F 05 â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”¼â”€ syscall  â”‚
â”‚                      â”‚   â”‚    C3            â”‚  â”‚   ici !   â”‚
â”‚                      â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚            â”‚
â”‚                      â”‚                          â”‚            â”‚
â”‚  0x00007FFE00000000 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚                      â”‚                          â”‚            â”‚
â”‚                      â”‚   KERNEL32.DLL           â”‚            â”‚
â”‚                      â”‚   KERNELBASE.DLL         â”‚            â”‚
â”‚                      â”‚   USER32.DLL             â”‚            â”‚
â”‚                      â”‚   ...                    â”‚            â”‚
â”‚                      â”‚                          â”‚            â”‚
â”‚  0x0000000140000000 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚                      â”‚                          â”‚            â”‚
â”‚                      â”‚   malware.exe            â”‚            â”‚
â”‚                      â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚            â”‚
â”‚                      â”‚   â”‚ .text            â”‚  â”‚            â”‚
â”‚                      â”‚   â”‚  - Notre code    â”‚  â”‚            â”‚
â”‚                      â”‚   â”‚  - Syscalls      â”‚  â”‚            â”‚
â”‚                      â”‚   â”‚    indirects     â”‚  â”‚            â”‚
â”‚                      â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚            â”‚
â”‚                      â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚            â”‚
â”‚                      â”‚   â”‚ .data            â”‚  â”‚            â”‚
â”‚                      â”‚   â”‚  - g_SyscallTableâ”‚  â”‚            â”‚
â”‚                      â”‚   â”‚  - g_FreshNtdll  â”‚  â”‚            â”‚
â”‚                      â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚            â”‚
â”‚                      â”‚                          â”‚            â”‚
â”‚  0x0000000000400000 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚                      â”‚                          â”‚            â”‚
â”‚                      â”‚   HEAP                   â”‚            â”‚
â”‚                      â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚            â”‚
â”‚                      â”‚   â”‚ Copie fraÃ®che de â”‚  â”‚            â”‚
â”‚  0x0000020A12340000 â”‚   â”‚ ntdll.dll        â”‚  â”‚ â† Propre ! â”‚
â”‚                      â”‚   â”‚ (aucun hook)     â”‚  â”‚            â”‚
â”‚                      â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚            â”‚
â”‚                      â”‚                          â”‚            â”‚
â”‚  0x0000000000010000 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”‚
â”‚                      â”‚   Stack                  â”‚            â”‚
â”‚  0x0000000000000000 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Flux de DÃ©tection EDR

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 EDR DETECTION LAYERS                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

LAYER 1: USER MODE HOOKS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ntdll.dll hooking        â”‚ â† Syscalls indirects bypass
â”‚ kernel32.dll hooking     â”‚ â† Facile Ã  contourner
â”‚ API monitoring           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ Si bypass...
        
LAYER 2: ETW MONITORING
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Event Tracing Windows    â”‚ â† Peut Ãªtre dÃ©sactivÃ©
â”‚ Memory allocation events â”‚   (techniques avancÃ©es)
â”‚ Thread creation events   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ Si bypass...
        
LAYER 3: KERNEL CALLBACKS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PsSetCreateProcessNotify â”‚ â† Niveau kernel
â”‚ PsSetCreateThreadNotify  â”‚   Plus difficile
â”‚ ObRegisterCallbacks      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ Si bypass...
        
LAYER 4: BEHAVIORAL ANALYSIS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Machine Learning         â”‚ â† Pattern matching
â”‚ Heuristics               â”‚   Peut dÃ©tecter mÃªme
â”‚ Anomaly detection        â”‚   les syscalls indirects
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼ Si bypass...
        
LAYER 5: NETWORK MONITORING
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ C2 communication         â”‚ â† Chiffrement nÃ©cessaire
â”‚ DNS queries              â”‚
â”‚ Traffic analysis         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

Ce fichier complÃ¨te le cours avec des schÃ©mas visuels pour mieux comprendre les concepts !
